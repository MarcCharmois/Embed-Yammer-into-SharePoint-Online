<!DOCTYPE html>
<html>
<head>
    <title></title>
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
     <script type="text/javascript" data-app-id="VblRzvoXpQXeWjSO3MEPOg" src="https://c64.assets-yammer.com/assets/platform_js_sdk.js"></script>
<!-- id yammer  gfi TWch6qS7d6hK0wyvXhyzg -->
<!-- id yammer grt VblRzvoXpQXeWjSO3MEPOg -->
<!-- group id gfi 6337655 -->
<!-- group id grt  6139158 -->
</head> 
<body>   

<!-- postmesssage -->
<script   src='https://ajax.googleapis.com/ajax/libs/jquery/1.6.3/jquery.min.js' ></script>
<script type="text/javascript">
	    var message="";
	    var groupId=0;
        var users = new Array();
	    var userName ="";
		var topicToPost="";

function postMessage() {
   topicToPost=getTopicValue();
   yamPostRequest(this);
/*

       yam.getLoginStatus( function(response) {
            if (response.authResponse) {
            yamPostRequest(this);
                
            } else {
              alert("vous allez être reconnecté...\nCliquez à nouveau sur le bouton pour publier votre message...\n si ça ne marche toujours pas, rafraîchissez la page dans votre navigateur...")
                yam.login( function (response) {
                  if (!response.authResponse) {
                    document.getElementById('yammer-login').style.display = 'none';
                    yamPostRequest(this);
                  }
                });
            }
        });
*/
    }


function getTopicValue() {

var radios = document.getElementsByName('topic');

for (var i = 0, length = radios.length; i < length; i++) {
    if (radios[i].checked) {
        // do whatever you want with the checked radio
        //alert(radios[i].value);
        return radios[i].value;

        // only one radio can be logically checked, don't check the rest
        break;
    }
}
}


function yamPostRequest(val)  {
   var msg_value = document.getElementById('msg_body').value;
   var groupID = "6139158"//document.getElementById('group_id').value;
      if(msg_value ==""){
        alert ("Message body cannot be empty!");
        return false;
     }else{
        //msg_value += "<!-- #Test -->";
     }
     
     if(groupID==""){

      var conf = confirm("Group ID is empty, message will be posted to all company")
      if(conf==false) { return false}

     }


if (topicToPost.length>0){

yam.platform.request(
   { 
      url: "https://api.yammer.com/api/v1/messages.json"
      , method: "POST"
      , data: {
       "body" :  msg_value
      ,"group_id" : groupID
      ,topic1 : topicToPost
	  ,"cc": "[[user:1537569057]],[[user:1550806780]]"
	  //,direct_to_id : "1537569057"
	  ,"skip_body_notifications" : "true"
     }
      , success: function (msg) { 
		document.getElementById('msg_body').value="";
		//alert("Post was Successful!"); 
		//document.getElementById('yammer-login').style.display = 'none';
}
      , error: function (msg) { alert("Impossible de publier votre message\nVeuillez vous reconnecter au moyen du bouton Login... "); }
      }
      )


}else{
yam.platform.request(
   { 
      url: "https://api.yammer.com/api/v1/messages.json"
      , method: "POST"
      , data: {
       "body" :  msg_value
      ,"group_id" : groupID
     }
      , success: function (msg) { 
document.getElementById('msg_body').value="";
//alert("Post was Successful!"); 
      //document.getElementById('yammer-login').style.display = 'none';
}
      , error: function (msg) { alert("Impossible de publier votre message\nVeuillez vous reconnecter au moyen du bouton Login... "); }
      }
      )
}
}

function getUserName (userId){

var userUrl = "https://api.yammer.com/api/v1/users/"+ userId + ".json";

yam.platform.request(
		{ 
      url: userUrl //"https://api.yammer.com/api/v1/users/1550806780.json"
      , method: "GET"
      ,success: function (user) { //print message response information to the console
					console.log("user id : " + userId);
                    console.log("user fuul_name : " + user.full_name);
                    //toggleLoginStatus(true);
                    /*$('#authResult').html('User Result:<br/>');
                    for (var field in user) {
                        $('#authResult').append(' ' + field + ': ' +
                            escape(user[field]) + '<br/>');
		    }*/
									document.getElementById('hidUser').value=user.full_name;
									return user.full_name;
								}
		,error: function (msg) { //alert( "error getUserName Ajax : " + msg.value); 
								}
		}
      )//,async:false;
}


function getMyFeed(origin){
message="";
document.getElementById("yammer-feed").innerHTML="<img src='/sites/portail-dircom/PublishingImages/ajax-loader1.gif' style='margin-top:100px;margin-left:95px;' />";

console.log("origine : " + origin);

yam.platform.request(
   { 
      url: "https://api.yammer.com/api/v1/messages/in_group/6139158.json" //https://api.yammer.com/api/v1/messages/in_group/6139158.json//"https://api.yammer.com/api/v1/users/1550806780.json"
      , method: "GET"
      ,success: function (data) { //print message response information to the console
      try{
		console.log('data received');
        for (var i = 0; i < data.messages.length; i++) {
		    groupId = parseInt(data.messages[i].group_id);
 		    userId = parseInt(data.messages[i].sender_id); 


            postBody=data.messages[i].body.plain;
		    message+= "<br><span style='color:rgba(0, 138, 94, 1);font-weight:bold;' >" + userName + "</span><br>" +  postBody + "<br>";
		    userName="";
       }
    		document.getElementById("yammer-feed").innerHTML=message;
	 }catch(error){
		alert("error getMyFeed process : " + error);
	}
	},
      error: function (msg) { alert("error getMyFeed ajax : " + msg.value); }
      }
      )
}


function getMyFeed3(origin){
message="";
document.getElementById("yammer-feed").innerHTML="<img src='/sites/portail-dircom/PublishingImages/ajax-loader1.gif' style='margin-top:100px;margin-left:95px;' />";

console.log("origine : " + origin);

var tokenToSend = "Bearer " + localStorage.getItem(1);
console.log("authorization bearer : " + tokenToSend);
yam.platform.request(
   { 
      url: "https://api.yammer.com/api/v1/messages/in_group/6139158.json" //https://api.yammer.com/api/v1/messages/in_group/6139158.json//"https://api.yammer.com/api/v1/users/1550806780.json"
	  ,method: "GET"
	  ,beforeSend: function (xhr){xhr.setRequestHeader('Authorization', tokenToSend)}
      ,success: function (data) { //print message response information to the console
      try{
		console.log('data received');
        for (var i = 0; i < data.messages.length; i++) {
		    groupId = parseInt(data.messages[i].group_id);
 		    userId = parseInt(data.messages[i].sender_id); 


            postBody=data.messages[i].body.plain;
		    message+= "<br><span style='color:rgba(0, 138, 94, 1);font-weight:bold;' >" + userName + "</span><br>" +  postBody + "<br>";
		    userName="";
       }
    		document.getElementById("yammer-feed").innerHTML=message;
	 }catch(error){
		alert("error getMyFeed process : " + error);
	}
	},
      error: function (msg) { alert("error getMyFeed ajax : " + msg.value); }
      }
      )
}


function getMyFeed2(){
message="";
document.getElementById("yammer-feed").innerHTML="<img src='/sites/portail-dircom/PublishingImages/ajax-loader1.gif' style='margin-top:100px;margin-left:95px;' />";
       var logged='false';
	   yam.getLoginStatus( function(response) {
            if (response.authResponse) {
			console.log('authresponse came from yam.getLoginStatus');
			localStorage.setItem(1, JSON.stringify(response.access_token.token).replace(/"/g, ""));
            getMyFeed("refresh"); 
                
            } else {
            //alert("vous allez être reconnecté...\nCliquez à nouveau sur le bouton pour publier votre message...\n si ça ne marche toujours pas, rafraîchissez la page dans votre navigateur...");
			getMyFeed3("preAuthenticated");
            }
        });
}
/*
yam.platform.login({ network: '{ateliersoffregrtgaz}' }, function (data) {

    console.log('login-status: ',data)
    if(data.status ==='connected')
        yam.platform.request({
            url: "oauth/tokens.json"     
            , method: "GET"
            , success: function (tokens) { console.log('user-tokens:',tokens); }
            , error: function (err) { alert("There was an error with the request."); }
        });
})*/
	</script>
<form name="Form2">
<div style="border:solid 1px silver;margin-bottom:5px;padding-top:2px;width:254px;">

<script>

  yam.connect.loginButton('#yammer-login', function (resp) {
    if (resp.authResponse) {
      //displayAuthResult(resp.access_token);
      localStorage.setItem(1, JSON.stringify(resp.access_token.token).replace(/"/g, ""));
	  console.log("token" + localStorage.getItem(1));

	  yam.platform.request({
            url: "oauth/tokens.json"     
            , method: "GET"
            , success: function (tokens) { console.log('user-tokens:',tokens); }
            , error: function (err) { alert("There was an error with the request."); }
        });
      //getUserName(1550806780);
	  document.getElementById('yammer-login').style.display = 'none';
	  getMyFeed("login");

    }
  });
/*
    yam.getLoginStatus( function(response) 
	{
		if (response.authResponse) {
		console.log('authresponse came from yam.getLoginStatus');
		localStorage.setItem(1, JSON.stringify(response.access_token.token).replace(/"/g, ""));
		document.getElementById('yammer-login').style.display = 'none';
		getMyFeed("refresh"); 
			
		} else {
		  //alert("vous allez être reconnecté...\nCliquez à nouveau sur le bouton pour publier votre message...\n si ça ne marche toujours pas, rafraîchissez la page dans votre navigateur...")
			yam.login( function (response) {
			  if (response.authResponse) {
				console.log('authresponse came from yam.login');
				localStorage.setItem(1, JSON.stringify(response.access_token.token).replace(/"/g, ""));
				document.getElementById('yammer-login').style.display = 'none';
				getMyFeed2();

			  }
			});

		}
	});
       */
</script>

 <table cellspacing="0" cellpadding="0" border="0">
 <tr>
	<td>
		<textarea style="margin-left:1px;" rows="8" cols="28" name="msg_body" id="msg_body"></textarea>
	</td>
  </tr>
<tr>
 <td>
	<input type="button" style="padding:3px;margin-left:1px;margin-top:5px;" value="Réagissez..." onclick ="postMessage()" /></td>
 </tr>
<!--
<tr>

 <td>

<br>
<input type="button" style="padding:3px;margin-left:1px;margin-top:5px;" value="Déconnexion (doesn't work yet)" onclick ="manualLogout();" /></td>
 </tr>
-->
 </table>
<input type="hidden" name="hidUser" id='hidUser' value="">
<div style="margin-top:5px;margin-bottom:7px;">
  <input style="font-size:10px" type="radio" name="topic" value="" checked><label style="font-size:13px">Sans topic</label> &nbsp; 
  <input type="radio" name="topic" value="Test"><label style="font-size:13px">Test</label>  &nbsp; 
  <input type="radio" name="topic" value="Spécification"><label style="font-size:13px">Spécification</label>  &nbsp; 
<br>
  <input type="radio" name="topic" value="Milestone"><label style="font-size:13px">Milestone</label>  &nbsp; 
  <input type="radio" name="topic" value="Perfs Yammer"><label style="font-size:13px">Perfs Yammer</label>  &nbsp; 
</div>
</div><!-- wrapper de la zone de saisie -->
<div id="embedded-feed" style="height:290px;width:255px;"></div>

<script type="text/javascript" src="https://assets.yammer.com/assets/platform_embed.js"></script>
<script type="text/javascript"> yam.connect.embedFeed({
	container: "#embedded-feed",
	network: "ateliersoffregrtgaz",
	feedType: "group",
	feedId: "6139158",
config :{
        header: false
        }
});
</script>
<style>
.message-list-item--body-message{
font-size:13px;
/*line-height:1.3;*/
color :#343a41;
font-family : "Segoe UI","Segoe",Tahoma,Helvetica,Arial,sans-serif;
}
</style>
<div style="border : solid 1px silver;border-bottom: 0px;width:254px;margin-top:11px;">
<img src='/sites/portail-dircom/PublishingImages/_t/LogoPortailDC_png.jpg?RenditionID=1' style='width:30px;margin: 5px 15px 0px 3px;float:left'/><div style='width:140px;float:left;font-size:14px;font-weight:bold;padding-top:15px;border-left:solid 0px silver;'>POC portail DC</div>
<a onclick="getMyFeed2();" href="javascript:;" style="text-decoration:none;"><img src="/sites/portail-dircom/PublishingImages/refresh%20icon.jpg?RenditionID=1" style="width:25px;margin: 5px 10px 0px 0px;border-style: none"   />
</a>
<!--input type='button' onclick='getMyFeed2()' value='refresh'-->
<div style='clear:both'></div>
</div>

<div id="webService-feed" style="height:236px;width:248px;border : solid 1px silver;border-top:0px;margin-top:0px;padding:3px;overflow: scroll;">
<span class='message-list-item--body-message' id="yammer-feed">
<span style="margin:3px 0px 3px 1px" id="yammer-login"></span>
</span>
</div>

<script>
	//getFeed("https://www.yammer.com/api/v1/messages/my_feed.json?limit:10");


function manualLogout (){
 
yam.getLoginStatus(
    function(response) {
      if(response.authResponse) {
        yam.platform.logout(function (response) {
          alert("user was logged out");
        })
      }
    }
  );
window.location ="https://uccint.sharepoint.com/sites/portail-dircom/yammerapp2.html";
}

function getFeed2(urlYammerWebService){ //https://www.yammer.com/api/v1/messages/my_feed.json
  //alert('getFeed');
  $.ajax({
    crossDomain: true,
    contentType : "text/plain; charset=utf-8",
                headers: {
                "Access-Control-Allow-Origin" : "*"
            },
    url:urlYammerWebService,
    type: "get",
    dataType: "jsonp",
    jsonp:true,
    success: function(data) {
    //alert('response received');
     try{
        for (var i = 0; i < data.messages.length; i++) {
		    groupId = parseInt(data.messages[i].group_id);
 		    userId = parseInt(data.messages[i].sender_id); 

		   

		if(groupId == '6139158'){

 		   for(j=0;j<users.length;j++){
			if((users.length>0) && (users[j][0]==userId)){
				userName=users[j][1];
				//alert('found : ' + userName);
			}
		    }

		    if(userName==""){
			
			userName = getUserName(userId);
			userName = document.getElementById('hidUser').value;
			//getUserName(userId);
			if(i==1){
				//alert(userName);
			}
			var user = new Array(userId, userName); 
			users[users.length]=user;
		    }

            postBody=data.messages[i].body.plain;
		    message+= "<br><span style='color:rgba(0, 138, 94, 1);font-weight:bold;' >" + userName + "</span><br>" +  postBody + "<br>";
		    userName="";
		}

       }//fin boucle data.messages
	
	//alert('nb de users distincts : ' + users.length);

    		document.getElementById("yammer-feed").innerHTML=message;
	 }catch(error){
		alert('error getFeed2 : ' + error);
	}
    },async:true
});
}
	
function getUserName2(userId){
//https://www.yammer.com/api/v1/users/1550806780.json

var urlYammerUserWS = 'https://www.yammer.com/api/v1/users/' + userId + '.json';
var userFullName=""
  $.ajax({
    crossDomain: true,
    url:urlYammerUserWS,
    type: 'get',
    dataType: "jsonp",
    success: function(data) {
    //alert('response received');
     try{
	
       //alert('user is : ' + data.full_name);
	userFullName = data.full_name;
	document.getElementById('hidUser').value=data.full_name;
	//alert(userFullName);
	return userFullName;
	 }catch(error){
		alert('get user error :' + error);
	}
    },async:false
});

//return userFullName;
}

function getFeed2(url){
//alert('getFeedUrl');
var xmlhttp;
if (window.XMLHttpRequest)
  {// code for IE7+, Firefox, Chrome, Opera, Safari
  xmlhttp=new XMLHttpRequest();
  }
else
  {// code for IE6, IE5
  xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
  }

xmlhttp.withCredentials=true;
xmlhttp.onreadystatechange=function()
  {
  if (xmlhttp.readyState==4 && xmlhttp.status==200)
    {
	try{
		alert('response received');
    		var doc = xmlhttp.responseXML;

    		var message="Emplacement du Mur ramené par web service";

    		document.getElementById("yammer-feed").innerHTML=message;
    	}catch(error)
	{
	  alert(error);
	}
    }else{
     //alert("error getting the response from the request");
  }
}
xmlhttp.open("GET",url,true);
xmlhttp.send();

}
</script>

</form>
</body>
</html>
